{% extends "base.html" %}

{% block title %}Dashboard - Sale Monitor{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1>Product Dashboard</h1>
        <div class="d-flex justify-content-between align-items-center mb-3">
            <p class="text-muted mb-0">Auto-refreshes every 60 seconds</p>
            <div>
                <input type="text" id="search-input" class="form-control form-control-sm d-inline-block" style="width: 200px;" placeholder="Search products...">
                <select id="status-filter" class="form-select form-select-sm d-inline-block ms-2" style="width: 150px;">
                    <option value="all">All Status</option>
                    <option value="enabled">Enabled Only</option>
                    <option value="disabled">Disabled Only</option>
                    <option value="alerts">Alerts Only</option>
                </select>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Trends (Last 30 Days)</h5>
                    <div>
                        <select id="trend-days" class="form-select form-select-sm" style="width: 140px;">
                            <option value="7">Last 7 days</option>
                            <option value="30" selected>Last 30 days</option>
                            <option value="90">Last 90 days</option>
                        </select>
                    </div>
                </div>
                <canvas id="trends-chart" style="max-height: 380px;" class="mt-3"></canvas>
                <div id="trends-empty" class="text-muted" style="display:none;">No history available yet.</div>
            </div>
        </div>
    </div>
</div>

<div id="loading" class="text-center my-5">
    <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<div id="products-table-container" style="display: none;">
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover table-striped align-middle mb-0" id="products-table">
                    <thead>
                        <tr>
                            <th style="cursor: pointer;" onclick="sortTable('name')">
                                Product <span id="sort-name-icon">‚¨ç</span>
                            </th>
                            <th style="cursor: pointer;" onclick="sortTable('merchant')">
                                Merchant <span id="sort-merchant-icon">‚¨ç</span>
                            </th>
                            <th style="cursor: pointer;" onclick="sortTable('price')">
                                Current Price <span id="sort-price-icon">‚¨ç</span>
                            </th>
                            <th>Status</th>
                            <th class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="products-tbody">
                        <!-- Products will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div id="empty-state" class="alert alert-info" style="display: none;">
    No products found. <a href="/manage">Add products</a> to get started.
</div>

<div id="error-alert" class="alert alert-danger" role="alert" style="display: none;">
    <strong>Error:</strong> <span id="error-message"></span>
</div>

<style>
/* Mobile dropdown for actions */
@media (max-width: 768px) {
    .action-buttons {
        display: none;
    }
    .action-dropdown {
        display: inline-block !important;
    }
}

@media (min-width: 769px) {
    .action-dropdown {
        display: none !important;
    }
}

.table th {
    user-select: none;
}

.table tbody tr:hover {
    background-color: rgba(0, 0, 0, 0.075);
}
</style>
{% endblock %}

{% block extra_scripts %}
<script>
let refreshInterval;
let trendsChart = null;
let allProducts = [];
let sortBy = 'name';
let sortDesc = false;

function getMerchant(product) {
    try {
        const u = new URL(product.url);
        // strip leading www.
        return u.hostname.replace(/^www\./, '');
    } catch (e) {
        // Fallback: quick parse
        const m = (product.url || '').match(/^https?:\/\/([^\/]+)/i);
        return m ? m[1].replace(/^www\./, '') : '';
    }
}

function parseUtcIso(dateStr) {
    if (!dateStr) return null;
    const hasTz = /[zZ]|[\+\-]\d{2}:?\d{2}$/.test(dateStr);
    const s = hasTz ? dateStr : `${dateStr}Z`;
    const d = new Date(s);
    return isNaN(d.getTime()) ? null : d;
}

function formatPrice(price) {
    if (price === null || price === undefined) {
        return '<span class="text-muted">N/A</span>';
    }
    return `$${parseFloat(price).toFixed(2)}`;
}

function getPriceStatus(product) {
    if (!product.current_price) return 'unknown';
    
    const current = parseFloat(product.current_price);
    
    if (product.target_price && current <= product.target_price) {
        return 'target-met';
    }
    
    if (product.discount_threshold && product.last_price) {
        const last = parseFloat(product.last_price);
        const drop = ((last - current) / last) * 100;
        if (drop >= product.discount_threshold) {
            return 'discount-met';
        }
    }
    
    return 'normal';
}

function getStatusBadge(status) {
    const badges = {
        'target-met': '<span class="badge bg-success">üéØ Target Met</span>',
        'discount-met': '<span class="badge bg-warning text-dark">üìâ Big Discount</span>',
        'normal': '<span class="badge bg-secondary">Watching</span>',
        'unknown': '<span class="badge bg-light text-dark">No Data</span>'
    };
    return badges[status] || badges.unknown;
}

function getEnabledBadge(enabled) {
    return enabled 
        ? '<span class="badge bg-success">Enabled</span>' 
        : '<span class="badge bg-secondary">Disabled</span>';
}

function renderProductRow(product) {
    const status = getPriceStatus(product);
    const statusBadge = getStatusBadge(status);
    const enabledBadge = getEnabledBadge(product.enabled);
    const historyUrl = `/product/detail?url=${encodeURIComponent(product.url)}`;
    const toggleText = product.enabled ? '‚è∏ Disable' : '‚ñ∂Ô∏è Enable';
    const toggleClass = product.enabled ? 'btn-warning' : 'btn-success';
    const merchant = getMerchant(product);
    
    return `
        <tr data-product-name="${product.name.toLowerCase()}" 
            data-status="${product.enabled ? 'enabled' : 'disabled'}" 
            data-alert="${status}"
            data-price="${product.current_price || 0}"
            data-merchant="${merchant.toLowerCase()}">
            <td><a href="${historyUrl}" class="text-decoration-none"><strong>${product.name}</strong></a></td>
            <td><a href="${product.url}" target="_blank" class="text-muted text-decoration-none">${merchant}</a></td>
            <td>${formatPrice(product.current_price)}</td>
            <td>${statusBadge} ${enabledBadge}</td>
            <td class="text-end">
                <div class="action-buttons btn-group btn-group-sm" role="group">
                    <button class="btn btn-outline-info" onclick="checkPrice('${product.url}', this)">üîÑ Check</button>
                    <button class="btn ${toggleClass}" onclick="toggleProduct('${product.url}', this)">${toggleText}</button>
                </div>
                <div class="action-dropdown dropdown" style="display: none;">
                    <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        Actions
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><button class="dropdown-item" onclick="checkPrice('${product.url}', this)">üîÑ Check Price</button></li>
                        <li><button class="dropdown-item" onclick="toggleProduct('${product.url}', this)">${toggleText}</button></li>
                    </ul>
                </div>
            </td>
        </tr>
    `;
}

function sortTable(column) {
    if (sortBy === column) {
        sortDesc = !sortDesc;
    } else {
        sortBy = column;
        sortDesc = false;
    }
    
    // Update sort icons
    document.getElementById('sort-name-icon').textContent = '‚¨ç';
    document.getElementById('sort-merchant-icon').textContent = '‚¨ç';
    document.getElementById('sort-price-icon').textContent = '‚¨ç';
    
    const icon = sortDesc ? '‚ñº' : '‚ñ≤';
    document.getElementById(`sort-${column}-icon`).textContent = icon;
    
    renderProducts();
}

function filterAndSortProducts() {
    const searchTerm = document.getElementById('search-input').value.toLowerCase();
    const statusFilter = document.getElementById('status-filter').value;
    
    let filtered = allProducts.filter(product => {
        const status = getPriceStatus(product);
        const matchesSearch = product.name.toLowerCase().includes(searchTerm);
        const matchesStatus = statusFilter === 'all' || 
                            (statusFilter === 'enabled' && product.enabled) ||
                            (statusFilter === 'disabled' && !product.enabled) ||
                            (statusFilter === 'alerts' && (status === 'target-met' || status === 'discount-met'));
        return matchesSearch && matchesStatus;
    });
    
    // Sort
    filtered.sort((a, b) => {
        let compareA, compareB;
        
        if (sortBy === 'name') {
            compareA = a.name.toLowerCase();
            compareB = b.name.toLowerCase();
        } else if (sortBy === 'merchant') {
            compareA = getMerchant(a).toLowerCase();
            compareB = getMerchant(b).toLowerCase();
        } else if (sortBy === 'price') {
            compareA = parseFloat(a.current_price || 0);
            compareB = parseFloat(b.current_price || 0);
        }
        
        if (compareA < compareB) return sortDesc ? 1 : -1;
        if (compareA > compareB) return sortDesc ? -1 : 1;
        return 0;
    });
    
    return filtered;
}

function renderProducts() {
    const filtered = filterAndSortProducts();
    const tbody = document.getElementById('products-tbody');
    
    if (filtered.length === 0) {
        document.getElementById('products-table-container').style.display = 'none';
        document.getElementById('empty-state').style.display = allProducts.length === 0 ? 'block' : 'none';
        if (allProducts.length > 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No products match your filters.</td></tr>';
            document.getElementById('products-table-container').style.display = 'block';
        }
    } else {
        document.getElementById('empty-state').style.display = 'none';
        document.getElementById('products-table-container').style.display = 'block';
        tbody.innerHTML = filtered.map(renderProductRow).join('');
    }
}

function loadProducts() {
    fetch('/api/products')
        .then(response => {
            if (!response.ok) throw new Error('Failed to fetch products');
            return response.json();
        })
        .then(products => {
            allProducts = products;
            document.getElementById('loading').style.display = 'none';
            renderProducts();
        })
        .catch(error => {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error-message').textContent = error.message;
            document.getElementById('error-alert').style.display = 'block';
        });
}

function uniq(arr) {
    return Array.from(new Set(arr));
}

function colorForIndex(i) {
    const hue = (i * 57) % 360;
    return `hsl(${hue}, 70%, 50%)`;
}

function loadTrends() {
    const days = document.getElementById('trend-days').value || 30;
    fetch(`/api/history/all?days=${encodeURIComponent(days)}`)
        .then(response => {
            if (!response.ok) throw new Error('Failed to fetch trends');
            return response.json();
        })
        .then(seriesList => {
            const canvas = document.getElementById('trends-chart');
            const emptyDiv = document.getElementById('trends-empty');
            if (trendsChart) { trendsChart.destroy(); trendsChart = null; }

            if (!seriesList || seriesList.length === 0) {
                emptyDiv.style.display = 'block';
                return;
            }
            emptyDiv.style.display = 'none';

            const allDates = uniq(seriesList.flatMap(item => item.series.map(p => {
                const d = parseUtcIso(p.timestamp);
                return d ? d.toISOString().slice(0,10) : null;
            }).filter(Boolean))).sort();

            const datasets = seriesList.map((item, idx) => {
                const dayMap = {};
                item.series.forEach(p => {
                    const dd = parseUtcIso(p.timestamp);
                    if (!dd) return;
                    const d = dd.toISOString().slice(0,10);
                    dayMap[d] = p.price;
                });
                const color = colorForIndex(idx);
                return {
                    label: item.name,
                    data: allDates.map(d => (d in dayMap ? dayMap[d] : null)),
                    borderColor: color,
                    backgroundColor: color.replace('70%', '70%').replace('50%', '80%'),
                    spanGaps: true,
                    tension: 0.15,
                };
            });

            const ctx = canvas.getContext('2d');
            trendsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: allDates.map(d => new Date(d).toLocaleDateString()),
                    datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: context => {
                                    const v = context.parsed.y;
                                    return `${context.dataset.label}: $${(v ?? 0).toFixed(2)}`;
                                }
                            }
                        }
                    },
                    interaction: { mode: 'nearest', intersect: false },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: value => `$${Number(value).toFixed(2)}`
                            }
                        }
                    }
                }
            });
        })
        .catch(err => {
            const emptyDiv = document.getElementById('trends-empty');
            emptyDiv.textContent = 'Unable to load trends.';
            emptyDiv.style.display = 'block';
        });
}

function toggleProduct(url, btn) {
    const originalHtml = btn.innerHTML;
    btn.disabled = true;
    
    fetch('/api/product/toggle', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({url: url})
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => { throw new Error(err.error || 'Request failed'); });
        }
        return response.json();
    })
    .then(result => {
        if (result.error) {
            showError(result.error);
            btn.disabled = false;
        } else {
            loadProducts();
        }
    })
    .catch(error => {
        showError(error.message);
        btn.innerHTML = originalHtml;
        btn.disabled = false;
    });
}

function checkPrice(url, btn) {
    const originalHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '‚è≥ Checking...';
    
    fetch('/api/product/check', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({url: url})
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => { throw new Error(err.error || 'Request failed'); });
        }
        return response.json();
    })
    .then(result => {
        if (result.error) {
            showError(result.error);
        } else {
            showSuccess(`Price updated: $${result.price.toFixed(2)}`);
            loadProducts();
        }
        btn.disabled = false;
        btn.innerHTML = originalHtml;
    })
    .catch(error => {
        showError(error.message);
        btn.disabled = false;
        btn.innerHTML = originalHtml;
    });
}

function showError(message) {
    document.getElementById('error-message').textContent = message;
    document.getElementById('error-alert').style.display = 'block';
    document.getElementById('error-alert').className = 'alert alert-danger';
    setTimeout(() => {
        document.getElementById('error-alert').style.display = 'none';
    }, 5000);
}

function showSuccess(message) {
    const alertDiv = document.getElementById('error-alert');
    document.getElementById('error-message').textContent = message;
    alertDiv.className = 'alert alert-success';
    alertDiv.style.display = 'block';
    
    if (window.successTimeout) clearTimeout(window.successTimeout);
    
    window.successTimeout = setTimeout(() => {
        alertDiv.style.display = 'none';
    }, 4000);
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('search-input').addEventListener('input', renderProducts);
    document.getElementById('status-filter').addEventListener('change', renderProducts);
    document.getElementById('trend-days').addEventListener('change', loadTrends);
});

// Initial load
loadProducts();
loadTrends();

// Auto-refresh every 60 seconds
refreshInterval = setInterval(() => { loadProducts(); loadTrends(); }, 60000);

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
    if (refreshInterval) clearInterval(refreshInterval);
    if (trendsChart) trendsChart.destroy();
});
</script>
{% endblock %}
