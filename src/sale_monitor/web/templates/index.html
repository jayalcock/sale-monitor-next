{% extends "base.html" %}

{% block title %}Dashboard - Sale Monitor{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1>Product Dashboard</h1>
        <div class="d-flex justify-content-between align-items-center mb-3">
            <p class="text-muted mb-0">Auto-refreshes every 60 seconds</p>
            <div>
                <input type="text" id="search-input" class="form-control form-control-sm d-inline-block" style="width: 200px;" placeholder="Search products...">
                <select id="status-filter" class="form-select form-select-sm d-inline-block ms-2" style="width: 150px;">
                    <option value="all">All Status</option>
                    <option value="enabled">Enabled Only</option>
                    <option value="disabled">Disabled Only</option>
                    <option value="alerts">Alerts Only</option>
                </select>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Trends (Last 30 Days)</h5>
                    <div>
                        <select id="trend-days" class="form-select form-select-sm" style="width: 140px;">
                            <option value="7">Last 7 days</option>
                            <option value="30" selected>Last 30 days</option>
                            <option value="90">Last 90 days</option>
                        </select>
                    </div>
                </div>
                <canvas id="trends-chart" style="max-height: 380px;" class="mt-3"></canvas>
                <div id="trends-empty" class="text-muted" style="display:none;">No history available yet.</div>
            </div>
        </div>
    </div>
    
</div>

<div id="loading" class="text-center my-5">
    <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<div id="products-container" class="row g-4" style="display: none;">
    <!-- Products will be inserted here -->
</div>

<div id="error-alert" class="alert alert-danger" role="alert" style="display: none;">
    <strong>Error:</strong> <span id="error-message"></span>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let refreshInterval;
let trendsChart = null;
let allProducts = [];

function parseUtcIso(dateStr) {
    if (!dateStr) return null;
    // If string lacks timezone info, treat it as UTC by appending 'Z'
    const hasTz = /[zZ]|[\+\-]\d{2}:?\d{2}$/.test(dateStr);
    const s = hasTz ? dateStr : `${dateStr}Z`;
    const d = new Date(s);
    return isNaN(d.getTime()) ? null : d;
}

function formatPrice(price) {
    if (price === null || price === undefined) {
        return '<span class="text-muted">N/A</span>';
    }
    return `$${parseFloat(price).toFixed(2)}`;
}

function formatDate(dateStr) {
    const date = parseUtcIso(dateStr);
    if (!date) return '<span class="text-muted">Never</span>';
    return date.toLocaleString();
}

function getPriceStatus(product) {
    if (!product.current_price) return 'unknown';
    
    const current = parseFloat(product.current_price);
    
    if (product.target_price && current <= product.target_price) {
        return 'target-met';
    }
    
    if (product.discount_threshold && product.last_price) {
        const last = parseFloat(product.last_price);
        const drop = ((last - current) / last) * 100;
        if (drop >= product.discount_threshold) {
            return 'discount-met';
        }
    }
    
    return 'normal';
}

function getStatusBadge(status) {
    const badges = {
        'target-met': '<span class="badge bg-success">üéØ Target Met</span>',
        'discount-met': '<span class="badge bg-warning text-dark">üìâ Big Discount</span>',
        'normal': '<span class="badge bg-secondary">Watching</span>',
        'unknown': '<span class="badge bg-light text-dark">No Data</span>'
    };
    return badges[status] || badges.unknown;
}

function renderProduct(product) {
    const status = getPriceStatus(product);
    const statusBadge = getStatusBadge(status);
    const enabledBadge = product.enabled 
        ? '<span class="badge bg-success">Enabled</span>' 
        : '<span class="badge bg-secondary">Disabled</span>';
    
    const historyUrl = `/product/detail?url=${encodeURIComponent(product.url)}`;
    
    return `
        <div class="col-md-6 col-lg-4" data-product-name="${product.name.toLowerCase()}" data-status="${product.enabled ? 'enabled' : 'disabled'}" data-alert="${status}">
            <div class="card h-100 ${status === 'target-met' ? 'border-success' : status === 'discount-met' ? 'border-warning' : ''}">
                <div class="card-body">
                    <h5 class="card-title">${product.name}</h5>
                    <p class="card-text">
                        <strong>Current:</strong> ${formatPrice(product.current_price)}<br>
                        <strong>Target:</strong> ${formatPrice(product.target_price)}<br>
                        <strong>Threshold:</strong> ${product.discount_threshold}%<br>
                        <strong>Last Check:</strong> ${formatDate(product.last_checked)}
                    </p>
                    <div class="mb-2">
                        ${statusBadge} ${enabledBadge}
                    </div>
                    <div class="btn-group w-100 mb-2" role="group">
                        <a href="${historyUrl}" class="btn btn-sm btn-primary">üìä History</a>
                        <a href="${product.url}" target="_blank" class="btn btn-sm btn-outline-secondary">üîó Open</a>
                        <button class="btn btn-sm btn-outline-info" onclick="checkPrice('${product.url}')">üîÑ Check</button>
                    </div>
                    <button class="btn btn-sm ${product.enabled ? 'btn-warning' : 'btn-success'} w-100" onclick="toggleProduct('${product.url}')">
                        ${product.enabled ? '‚è∏ Disable' : '‚ñ∂Ô∏è Enable'}
                    </button>
                </div>
            </div>
        </div>
    `;
}

function filterProducts() {
    const searchTerm = document.getElementById('search-input').value.toLowerCase();
    const statusFilter = document.getElementById('status-filter').value;
    
    document.querySelectorAll('[data-product-name]').forEach(card => {
        const name = card.getAttribute('data-product-name');
        const status = card.getAttribute('data-status');
        const alert = card.getAttribute('data-alert');
        
        const matchesSearch = name.includes(searchTerm);
        const matchesStatus = statusFilter === 'all' || 
                            (statusFilter === 'enabled' && status === 'enabled') ||
                            (statusFilter === 'disabled' && status === 'disabled') ||
                            (statusFilter === 'alerts' && (alert === 'target-met' || alert === 'discount-met'));
        
        card.style.display = (matchesSearch && matchesStatus) ? '' : 'none';
    });
}

function loadProducts() {
    fetch('/api/products')
        .then(response => {
            if (!response.ok) throw new Error('Failed to fetch products');
            return response.json();
        })
        .then(products => {
            allProducts = products;
            document.getElementById('loading').style.display = 'none';
            // Don't hide error-alert if it's currently showing a message
            const errorAlert = document.getElementById('error-alert');
            if (errorAlert.style.display !== 'block') {
                errorAlert.style.display = 'none';
            }
            
            const container = document.getElementById('products-container');
            container.style.display = 'flex';
            
            if (products.length === 0) {
                container.innerHTML = '<div class="col-12"><div class="alert alert-info">No products found. <a href="/manage">Add products</a> to get started.</div></div>';
            } else {
                container.innerHTML = products.map(renderProduct).join('');
                filterProducts();
            }
        })
        .catch(error => {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error-message').textContent = error.message;
            document.getElementById('error-alert').style.display = 'block';
        });
}

function uniq(arr) {
    return Array.from(new Set(arr));
}

function colorForIndex(i) {
    // Pleasant distinct HSL palette
    const hue = (i * 57) % 360; // pseudo-random spread
    return `hsl(${hue}, 70%, 50%)`;
}

function loadTrends() {
    const days = document.getElementById('trend-days').value || 30;
    fetch(`/api/history/all?days=${encodeURIComponent(days)}`)
        .then(response => {
            if (!response.ok) throw new Error('Failed to fetch trends');
            return response.json();
        })
        .then(seriesList => {
            const canvas = document.getElementById('trends-chart');
            const emptyDiv = document.getElementById('trends-empty');
            if (trendsChart) { trendsChart.destroy(); trendsChart = null; }

            if (!seriesList || seriesList.length === 0) {
                emptyDiv.style.display = 'block';
                return;
            }
            emptyDiv.style.display = 'none';

            // Build a unified set of date labels (by day)
            const allDates = uniq(seriesList.flatMap(item => item.series.map(p => {
                const d = parseUtcIso(p.timestamp);
                return d ? d.toISOString().slice(0,10) : null;
            }).filter(Boolean))).sort();

            const datasets = seriesList.map((item, idx) => {
                // Map day -> latest price for that day
                const dayMap = {};
                item.series.forEach(p => {
                    const dd = parseUtcIso(p.timestamp);
                    if (!dd) return;
                    const d = dd.toISOString().slice(0,10);
                    dayMap[d] = p.price; // latest seen wins
                });
                const color = colorForIndex(idx);
                return {
                    label: item.name,
                    data: allDates.map(d => (d in dayMap ? dayMap[d] : null)),
                    borderColor: color,
                    backgroundColor: color.replace('70%', '70%').replace('50%', '80%'),
                    spanGaps: true,
                    tension: 0.15,
                };
            });

            const ctx = canvas.getContext('2d');
            trendsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: allDates.map(d => new Date(d).toLocaleDateString()),
                    datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: context => {
                                    const v = context.parsed.y;
                                    return `${context.dataset.label}: $${(v ?? 0).toFixed(2)}`;
                                }
                            }
                        }
                    },
                    interaction: { mode: 'nearest', intersect: false },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: value => `$${Number(value).toFixed(2)}`
                            }
                        }
                    }
                }
            });
        })
        .catch(err => {
            // Non-fatal for dashboard; show small message in empty area
            const emptyDiv = document.getElementById('trends-empty');
            emptyDiv.textContent = 'Unable to load trends.';
            emptyDiv.style.display = 'block';
        });
}

function toggleProduct(url) {
    fetch('/api/product/toggle', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({url: url})
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => { throw new Error(err.error || 'Request failed'); });
        }
        return response.json();
    })
    .then(result => {
        if (result.error) {
            showError(result.error);
        } else {
            loadProducts();
        }
    })
    .catch(error => showError(error.message));
}

function checkPrice(url) {
    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = '‚è≥ Checking...';
    
    fetch('/api/product/check', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({url: url})
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => { throw new Error(err.error || 'Request failed'); });
        }
        return response.json();
    })
    .then(result => {
        if (result.error) {
            showError(result.error);
        } else {
            showSuccess(`Price updated: $${result.price.toFixed(2)}`);
            loadProducts();
        }
        btn.disabled = false;
        btn.innerHTML = 'üîÑ Check';
    })
    .catch(error => {
        showError(error.message);
        btn.disabled = false;
        btn.innerHTML = 'üîÑ Check';
    });
}

function showError(message) {
    document.getElementById('error-message').textContent = message;
    document.getElementById('error-alert').style.display = 'block';
    document.getElementById('error-alert').className = 'alert alert-danger';
    setTimeout(() => {
        document.getElementById('error-alert').style.display = 'none';
    }, 5000);
}

function showSuccess(message) {
    const alertDiv = document.getElementById('error-alert');
    document.getElementById('error-message').textContent = message;
    alertDiv.className = 'alert alert-success';
    alertDiv.style.display = 'block';
    
    // Clear any existing timeout
    if (window.successTimeout) clearTimeout(window.successTimeout);
    
    window.successTimeout = setTimeout(() => {
        alertDiv.style.display = 'none';
    }, 4000);
}

// Event listeners for filters
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('search-input').addEventListener('input', filterProducts);
    document.getElementById('status-filter').addEventListener('change', filterProducts);
    document.getElementById('trend-days').addEventListener('change', loadTrends);
});

// Initial load
loadProducts();
loadTrends();

// Auto-refresh every 60 seconds
refreshInterval = setInterval(() => { loadProducts(); loadTrends(); }, 60000);

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
    if (refreshInterval) clearInterval(refreshInterval);
    if (trendsChart) trendsChart.destroy();
});
</script>
{% endblock %}
