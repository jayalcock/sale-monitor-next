{% extends "base.html" %}

{% block title %}Manage Products - Sale Monitor{% endblock %}

{% block content %}
<div id="error-alert" class="alert alert-danger" role="alert" style="display: none;">
    <strong>Error:</strong> <span id="error-message"></span>
</div>

<div class="row mb-3">
    <div class="col-12">
        <h1>Manage Products</h1>
        <p class="text-muted">Add, edit, or remove products from monitoring</p>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addProductModal">
            <span>‚ûï</span> Add New Product
        </button>
        <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#bookmarkletModal">
            üîñ Selector Picker Tool
        </button>
        <button class="btn btn-warning" onclick="bulkAutoDetect()" id="bulkAutoDetectBtn">
            üîç Try Auto-Detect All
        </button>
        <a href="/" class="btn btn-secondary">‚Üê Back to Dashboard</a>
    </div>
</div>

<div id="loading" class="text-center my-5">
    <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<div id="products-table" style="display: none;">
    <div class="table-responsive">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Status</th>
                    <th>Selector</th>
                    <th>Target Price</th>
                    <th>Discount %</th>
                    <th>Cooldown (hrs)</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="products-tbody">
                <!-- Populated by JS -->
            </tbody>
        </table>
    </div>
</div>

<!-- Add Product Modal -->
<div class="modal fade" id="addProductModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addProductForm">
                    <div class="mb-3">
                        <label class="form-label">Product Name *</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Product URL *</label>
                        <input type="url" class="form-control" name="url" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">CSS Selector <span class="text-muted">(optional - auto-detection will be used if empty)</span></label>
                        <input type="text" class="form-control" name="selector" placeholder="e.g., .price, #product-price">
                        <div class="form-text">Leave empty to use automatic price detection. Provide a CSS selector for more control.</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Target Price</label>
                        <input type="text" inputmode="decimal" class="form-control" name="target_price" placeholder="e.g., 99.99">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Discount Threshold (%)</label>
                        <input type="text" inputmode="decimal" class="form-control" name="discount_threshold" placeholder="e.g., 15">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notification Cooldown (hours)</label>
                        <input type="text" inputmode="numeric" class="form-control" name="notification_cooldown_hours" value="24" placeholder="e.g., 24">
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" name="enabled" checked>
                        <label class="form-check-label">Enabled</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addProduct()">Add Product</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Product Modal -->
<div class="modal fade" id="editProductModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editProductForm">
                    <input type="hidden" name="url" id="edit-url">
                    <div class="mb-3">
                        <label class="form-label">Product Name *</label>
                        <input type="text" class="form-control" name="name" id="edit-name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">CSS Selector <span class="text-muted">(optional - auto-detection will be used if empty)</span></label>
                        <input type="text" class="form-control" name="selector" id="edit-selector" placeholder="e.g., .price, #product-price">
                        <div class="form-text">Leave empty to use automatic price detection. Provide a CSS selector for more control.</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Target Price</label>
                        <input type="text" inputmode="decimal" class="form-control" name="target_price" id="edit-target-price" placeholder="e.g., 99.99">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Discount Threshold (%)</label>
                        <input type="text" inputmode="decimal" class="form-control" name="discount_threshold" id="edit-discount" placeholder="e.g., 15">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notification Cooldown (hours)</label>
                        <input type="text" inputmode="numeric" class="form-control" name="notification_cooldown_hours" id="edit-cooldown" placeholder="e.g., 24">
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" name="enabled" id="edit-enabled">
                        <label class="form-check-label">Enabled</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateProduct()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Bookmarklet Modal -->
<div class="modal fade" id="bookmarkletModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Price Selector Picker Tool</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Use this bookmarklet to easily find price selectors on product pages:</p>
                
                <h6 class="mt-3">üìñ How to Use:</h6>
                <ol>
                    <li>Drag the button below to your bookmarks bar, or right-click and bookmark it</li>
                    <li>Navigate to any product page where you want to monitor prices</li>
                    <li>Click the bookmarklet in your bookmarks bar</li>
                    <li>Click on the price element on the page</li>
                    <li>The CSS selector will be copied to your clipboard automatically</li>
                    <li>Paste it into the "CSS Selector" field when adding/editing a product</li>
                </ol>
                
                <h6 class="mt-3">üîñ Bookmarklet:</h6>
                <div class="alert alert-info">
                    <p class="mb-2"><strong>Drag this link to your bookmarks bar:</strong></p>
                    <a href="javascript:(function(){const style=document.createElement('style');style.textContent='.sm-picker-highlight{outline:3px solid #00ff00 !important;background:rgba(0,255,0,0.1) !important;cursor:crosshair !important;}';document.head.appendChild(style);let selectedEl=null;const onClick=e=>{e.preventDefault();e.stopPropagation();const el=e.target;const path=[];let current=el;while(current&&current!==document.body){let selector='';if(current.id){selector='#'+current.id;path.unshift(selector);break;}else{let sibling=current;let nth=1;while(sibling.previousElementSibling){sibling=sibling.previousElementSibling;nth++;}const tag=current.tagName.toLowerCase();const classes=Array.from(current.classList).filter(c=>c!=='sm-picker-highlight').map(c=>'.'+c).join('');selector=tag+classes+(nth>1?':nth-child('+nth+')':'');path.unshift(selector);}current=current.parentElement;}const cssSelector=path.join(' > ');navigator.clipboard.writeText(cssSelector).then(()=>{alert('‚úÖ CSS Selector copied to clipboard:\\n'+cssSelector);}).catch(()=>{prompt('Copy this CSS selector:',cssSelector);});cleanup();};const onMouseOver=e=>{e.target.classList.add('sm-picker-highlight');};const onMouseOut=e=>{e.target.classList.remove('sm-picker-highlight');};const cleanup=()=>{document.removeEventListener('click',onClick,true);document.removeEventListener('mouseover',onMouseOver,true);document.removeEventListener('mouseout',onMouseOut,true);style.remove();};document.addEventListener('click',onClick,true);document.addEventListener('mouseover',onMouseOver,true);document.addEventListener('mouseout',onMouseOut,true);alert('üéØ Selector Picker Activated!\\nClick on the price element on this page.');})();" 
                          class="btn btn-success btn-lg" 
                          onclick="return false;">
                        üéØ Pick Selector
                    </a>
                </div>
                
                <h6 class="mt-3">üí° Tips:</h6>
                <ul>
                    <li>Click on the actual price number, not surrounding elements</li>
                    <li>The tool will highlight elements as you hover over them</li>
                    <li>Generated selectors work best when they're specific to the price element</li>
                    <li>If auto-detection works for your site, you don't need a manual selector</li>
                </ul>
                
                <div class="alert alert-warning mt-3">
                    <strong>Note:</strong> This bookmarklet requires clipboard access. If it doesn't work, you'll see a prompt to copy the selector manually.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
let productsData = [];

function loadProducts() {
    fetch('/api/products')
        .then(response => response.json())
        .then(products => {
            productsData = products;
            document.getElementById('loading').style.display = 'none';
            document.getElementById('products-table').style.display = 'block';
            
            const tbody = document.getElementById('products-tbody');
            tbody.innerHTML = products.map(renderProductRow).join('');
        })
        .catch(error => {
            document.getElementById('loading').style.display = 'none';
            showError(error.message);
        });
}

function renderProductRow(product) {
    const statusBadge = product.enabled 
        ? '<span class="badge bg-success">Enabled</span>' 
        : '<span class="badge bg-secondary">Disabled</span>';
    
    // Determine selector display
    let selectorDisplay = '';
    if (product.selector) {
        const selectorSource = product.selector_source || 'manual';
        const sourceBadge = selectorSource === 'auto' 
            ? '<span class="badge bg-info">Auto</span>' 
            : selectorSource === 'manual'
            ? '<span class="badge bg-primary">Manual</span>'
            : '<span class="badge bg-warning">Bookmarklet</span>';
        selectorDisplay = `<code class="text-truncate d-inline-block" style="max-width: 150px;" title="${product.selector}">${product.selector}</code> ${sourceBadge}`;
    } else {
        selectorDisplay = '<span class="badge bg-info">Auto-detect</span>';
    }
    
    return `
        <tr>
            <td><strong>${product.name}</strong><br><small class="text-muted">${product.url}</small></td>
            <td>${statusBadge}</td>
            <td>${selectorDisplay}</td>
            <td>${product.target_price ? '$' + parseFloat(product.target_price).toFixed(2) : '-'}</td>
            <td>${product.discount_threshold ? product.discount_threshold + '%' : '-'}</td>
            <td>${product.notification_cooldown_hours}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick='editProduct(${JSON.stringify(product)})'>Edit</button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct('${product.url}', '${product.name}')">Delete</button>
            </td>
        </tr>
    `;
}

function addProduct() {
    const form = document.getElementById('addProductForm');
    const formData = new FormData(form);
    
    const data = {
        name: formData.get('name'),
        url: formData.get('url'),
        selector: formData.get('selector') || '',  // Allow empty selector
        target_price: formData.get('target_price') || null,
        discount_threshold: formData.get('discount_threshold') || null,
        notification_cooldown_hours: formData.get('notification_cooldown_hours') || 24,
        enabled: formData.get('enabled') === 'on'
    };
    
    fetch('/api/product/add', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => { throw new Error(err.error || 'Request failed'); });
        }
        return response.json();
    })
    .then(result => {
        if (result.error) {
            showError(result.error);
        } else {
            bootstrap.Modal.getInstance(document.getElementById('addProductModal')).hide();
            form.reset();
            loadProducts();
        }
    })
    .catch(error => showError(error.message));
}

function editProduct(product) {
    document.getElementById('edit-url').value = product.url;
    document.getElementById('edit-name').value = product.name;
    document.getElementById('edit-selector').value = product.selector;
    document.getElementById('edit-target-price').value = product.target_price || '';
    document.getElementById('edit-discount').value = product.discount_threshold || '';
    document.getElementById('edit-cooldown').value = product.notification_cooldown_hours;
    document.getElementById('edit-enabled').checked = product.enabled;
    
    new bootstrap.Modal(document.getElementById('editProductModal')).show();
}

function updateProduct() {
    const form = document.getElementById('editProductForm');
    const formData = new FormData(form);
    
    const data = {
        url: formData.get('url'),
        name: formData.get('name'),
        selector: formData.get('selector') || '',  // Allow empty selector
        target_price: formData.get('target_price') || null,
        discount_threshold: formData.get('discount_threshold') || null,
        notification_cooldown_hours: formData.get('notification_cooldown_hours'),
        enabled: formData.get('enabled') === 'on'
    };
    
    fetch('/api/product/update', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => { throw new Error(err.error || 'Request failed'); });
        }
        return response.json();
    })
    .then(result => {
        if (result.error) {
            showError(result.error);
        } else {
            bootstrap.Modal.getInstance(document.getElementById('editProductModal')).hide();
            loadProducts();
        }
    })
    .catch(error => showError(error.message));
}

function deleteProduct(url, name) {
    if (!confirm(`Are you sure you want to delete "${name}"?`)) {
        return;
    }
    
    fetch('/api/product/delete', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({url: url})
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => { throw new Error(err.error || 'Request failed'); });
        }
        return response.json();
    })
    .then(result => {
        if (result.error) {
            showError(result.error);
        } else {
            loadProducts();
        }
    })
    .catch(error => showError(error.message));
}

function showError(message) {
    document.getElementById('error-message').textContent = message;
    document.getElementById('error-alert').style.display = 'block';
    setTimeout(() => {
        document.getElementById('error-alert').style.display = 'none';
    }, 5000);
}

function bulkAutoDetect() {
    if (!confirm('This will attempt to auto-detect price selectors for all products. Continue?')) {
        return;
    }
    
    const btn = document.getElementById('bulkAutoDetectBtn');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Detecting...';
    
    fetch('/api/products/auto-detect-all', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => { throw new Error(err.error || 'Request failed'); });
        }
        return response.json();
    })
    .then(result => {
        btn.disabled = false;
        btn.innerHTML = originalText;
        
        if (result.error) {
            showError(result.error);
        } else {
            const msg = `Auto-detection completed!\n\nSuccessful: ${result.successful}\nFailed: ${result.failed}\n\nCheck the updated selectors in the table below.`;
            alert(msg);
            loadProducts();
        }
    })
    .catch(error => {
        btn.disabled = false;
        btn.innerHTML = originalText;
        showError(error.message);
    });
}

// Load on page load
loadProducts();
</script>
{% endblock %}
