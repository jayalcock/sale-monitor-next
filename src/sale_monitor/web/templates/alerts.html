{% extends "base.html" %}

{% block title %}Price Alerts - Sale Monitor{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-12">
        <h1>üîî Price Alerts</h1>
        <p class="text-muted">Products that have met their price targets or discount thresholds</p>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <a href="/" class="btn btn-secondary">‚Üê Back to Dashboard</a>
        <button class="btn btn-success" onclick="loadAlerts()">üîÑ Refresh</button>
    </div>
</div>

<div id="loading" class="text-center my-5">
    <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<div id="alerts-container" style="display: none;">
    <div id="no-alerts" class="alert alert-info" style="display: none;">
        <strong>No active alerts!</strong> All products are above their target prices and discount thresholds.
    </div>
    
    <div id="alerts-list" class="row g-4">
        <!-- Populated by JS -->
    </div>
</div>

<div id="error-alert" class="alert alert-danger" role="alert" style="display: none;">
    <strong>Error:</strong> <span id="error-message"></span>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function formatPrice(price) {
    return `$${parseFloat(price).toFixed(2)}`;
}

function formatDate(dateStr) {
    if (!dateStr) return 'Never';
    const date = new Date(dateStr);
    return date.toLocaleString();
}

function renderAlert(alert) {
    const isTarget = alert.alert_type === 'target_met';
    const cardClass = isTarget ? 'border-success' : 'border-warning';
    const badgeClass = isTarget ? 'bg-success' : 'bg-warning text-dark';
    const icon = isTarget ? 'üéØ' : 'üìâ';
    const title = isTarget ? 'Target Price Met' : 'Big Discount';
    
    return `
        <div class="col-md-6 col-lg-4">
            <div class="card h-100 ${cardClass} border-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h5 class="card-title">${alert.name}</h5>
                        <span class="badge ${badgeClass}">${icon} ${title}</span>
                    </div>
                    <p class="card-text">
                        <strong>Current Price:</strong> ${formatPrice(alert.current_price)}<br>
                        <strong>Alert:</strong> ${alert.message}<br>
                        <strong>Last Checked:</strong> ${formatDate(alert.last_checked)}
                    </p>
                    <div class="mt-3">
                        <a href="/product/detail?url=${encodeURIComponent(alert.url)}" class="btn btn-sm btn-primary">View History</a>
                        <a href="${alert.url}" target="_blank" class="btn btn-sm btn-success">Buy Now</a>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function loadAlerts() {
    document.getElementById('loading').style.display = 'block';
    document.getElementById('alerts-container').style.display = 'none';
    
    fetch('/api/alerts')
        .then(response => {
            if (!response.ok) throw new Error('Failed to fetch alerts');
            return response.json();
        })
        .then(alerts => {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('alerts-container').style.display = 'block';
            
            if (alerts.length === 0) {
                document.getElementById('no-alerts').style.display = 'block';
                document.getElementById('alerts-list').innerHTML = '';
            } else {
                document.getElementById('no-alerts').style.display = 'none';
                document.getElementById('alerts-list').innerHTML = alerts.map(renderAlert).join('');
            }
        })
        .catch(error => {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error-message').textContent = error.message;
            document.getElementById('error-alert').style.display = 'block';
        });
}

// Initial load
loadAlerts();

// Auto-refresh every 60 seconds
setInterval(loadAlerts, 60000);
</script>
{% endblock %}
